---
title: 'Analyses'
author: 
output: 
  github_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r "setup", include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center",
                      fig.path=('../../report/figures/'))
library(printr)
options(digits = 2)
library(rmarkdown)
library(here)
```

# Scripts
- [Required Packages &amp; Reproducibility](#required-packages-&amp;-reproducibility)
- [Analyses](#analyses)
  - [Balance Checks](#balance-checks)
  - [Gender Hypothesis](#gender-hypothesis)
  - [Migration Hypothesis](#migration-hypothesis)
  - [Intersection Hypothesis](#intersection-hypothesis)
  - [Intersection Hypothesis -- Pooled](#intersection-hypothesis--pooled)

# Required Packages &amp; Reproducibility
```{r "env", message=FALSE, warning=F}
rm(list=ls())
source(here("src/lib/functions.R"))
```

# Analyses
```{r "data for analyses"}
load(here("data/intermediate/cleaned_data.RData"))
source(here("src/analysis/data-for-analyses.R"))
```

Next, we automatically extract a `.md` file for the online appendix, as well as a  latex table for the manuscript. 
We are using jinja2 template [src/analysis/table_descriptives.tex.j2](table.tex.j2) which is called with a json string containing the data.
To replicate, make sure `env/bin/pip install -U j2cli` is installed via your command line.

```{r "Table with Descriptives"}
source(here("src/analysis/descriptive-information-overview.R"))
table2 <- knitr::kable(descr, digits=2)
fn <- here("report/figures/table_descriptives.tex")
cat("# Table: Descriptive Information of Variables under Study \n\n", file=fn)
cat(table2, file=fn, sep="\n", append=T)

methodnames <- setNames(as.list(descr$name), descr$name)
table <- purrr::map(descr, .f= ".") 
#render_j2("src/analysis/table_descriptives.tex.j2", "report/figures/table_descriptives.tex", data=list(data=table, methods=methodnames))
```

## Descriptive Results
```{r "descriptive-results", echo=FALSE}
d %>%
  select(PT1, PT2, PT3, PT4, issue, name, compromise) %>%
  pivot_longer(cols = PT1:PT4,
               names_to = "dvs") %>%
  mutate(dvs = recode(dvs,
                      `PT1` = "DV: Trait Evaluation",
                      `PT2` = "DV: Favorability",
                      `PT3` = "DV: Representation",
                      `PT4` = "DV: Career Prospects"),
         compromise = if_else(compromise==1, "Compromise", "No Compromise")) %>%
  group_by(issue, dvs, name, compromise) %>%
  summarise(means = mean(value, na.rm=T),
            stdev = sd(value, na.rm=T)) %>%
  mutate(lower = means - (1.56 * stdev),
         upper = means + (1.56 * stdev)) %>%
  ggplot(aes(x = reorder(dvs, means), y = means, colour = issue,
             ymin = lower, ymax = upper, label = issue)) +
  geom_point(position = position_dodge(.2)) + 
  geom_errorbar(position = position_dodge(.2), width = 0) +
  labs(y = "0 (negative) - 10 (positive)", 
       x = "", title = "Bend or Break?") +
  geom_hline(yintercept = 5, linetype = "dotted", color = "darkgrey") +
  theme_minimal() +
  facet_grid(name~compromise, scales = "free") +
  scale_color_manual(values = fig_cols) +
  coord_flip() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position="bottom",
        legend.title = element_blank()) 
```

## Balance Checks
```{r "balance-checks", eval = F}
source(here("src/analysis/balance-test.R"))
```

## Gender Hypothesis 
```{r "h1", fig.align="center", fig.height=8, fig.width=8, eval = F}
source(here("src/analysis/h1.R"))
```

## Migration Hypothesis
```{r "h2", fig.align="center", fig.height=8, fig.width=8, eval = F}
source(here("src/analysis/h2.R"))
```

## Intersection Hypothesis
```{r "h3", fig.align="center", fig.height=8, fig.width=8, eval = F}
source(here("src/analysis/h3.R"))
```

## Intersection Hypothesis -- Pooled
```{r "h3-pooled", fig.align="center", fig.height=8, fig.width=8, eval = F}
source(here("src/analysis/h3-pooled.R"))
```

## Exploration
